language: php
php:
- 7.2
- 7.3
- nightly

matrix:
  allow_failures:
  - php: nightly

dist: xenial
os: linux
cache:
  yarn: true
  directories:
  - node_modules
  - vendor
  - "$HOME/pecl_cache"
notifications:
  email:
    on_success: change
    on_failure: always
  slack:
    secure: GIS8bQ83gHuPO7dwcy4h3UJLYeRckI+eEBH/xkcrOEkPbxU15DWpAuBBXqyeW+bFHsE+ujVYZiA14HPtS6uQjsha2kz7fLmJYvAFPbA6NaEdF/C73UPlhKKVPnQfhv1FHJuU6FyXmuubTdvx6im3HglFQV7Ps2JcY+ZzBVnoWauysMrKh3tqSwy9I3/WmBl/7kA80I2q9SnzUUpEsCoXCgOEU3ahTuZr3Ta9k5Ap8S2fqAmte+ifFPr7l84af1E3o7kVPP61DRoHy+jj51KR8bLXX3aO0jwush1edScPK4KgvFCpY/Lk6H6F5MHV3Tz0yuuZYuD8iIL1yX7LynW8X8d17EDtohWpM8pBcMOCGJvyq/hnaVHSlpdKpyXdwD/srlmTonbtkDes07987pKrWFrtVi5QZPF1QllBrAO8soUYq0M5lhhqOSkQBYw2idSVUYDksDJibYiBpqPP1qHz52VN4JGSUSBQ4exkx7KR/TwrSO4nZkyM8llW/pyBLQ5fJROL63Q4DqJkz4by1rWtTjNzsTJmpU5dBffvDIV1l9bD8D6rowmtAA/uDK909v9KUOvy1vsyU/loWXvoLM9P3vUyvvKSKcjpxKpIoKJAdzC42CXkLCShw+Ic5e7yysdn1wn+gf85/XQawXSuUZKgLr6L8oeMGGUleCvwXeRCGGE=
    on_success: change
    on_failure: always
services:
- redis-server
- mongodb
before_install:
- travis/ci-pecl-install mongodb
#- pecl install mongodb
install:
- cp .env.travis .env
- composer self-update
- composer install --no-interaction
- php artisan key:generate
- node -v
- yarn install
- yarn run prod
script:
- vendor/bin/phpunit
- if [ -f storage/logs/laravel.log ]; then cat storage/logs/laravel.log; fi
after_success:
- vendor/bin/infection
- if [ $TRAVIS_BRANCH == 'master' ] && [ $TRAVIS_PHP_VERSION == '7.2' ]; then git clone git@github.com:citymatters/citymatters.git $TRAVIS_BUILD_DIR/temp; fi
- if [ $TRAVIS_BRANCH == 'master' ] && [ $TRAVIS_PHP_VERSION == '7.2' ]; then cd $TRAVIS_BUILD_DIR/temp; fi
- if [ $TRAVIS_BRANCH == 'master' ] && [ $TRAVIS_PHP_VERSION == '7.2' ]; then git checkout production; fi
- if [ $TRAVIS_BRANCH == 'master' ] && [ $TRAVIS_PHP_VERSION == '7.2' ]; then git merge --ff-only "$TRAVIS_COMMIT"; fi
- if [ $TRAVIS_BRANCH == 'master' ] && [ $TRAVIS_PHP_VERSION == '7.2' ]; then git push origin production; fi
